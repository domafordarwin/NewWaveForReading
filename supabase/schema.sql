-- Core tables for the literacy assessment app

-- =====================================================
-- 학교 관리 테이블
-- =====================================================
create table if not exists public.schools (
  school_id bigint generated by default as identity primary key,
  school_name text not null,
  school_code text unique,
  address text,
  phone text,
  region text,
  school_type text,
  is_active boolean default true,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- =====================================================
-- 사용자 테이블 (확장)
-- user_type: STUDENT, PARENT, SCHOOL_ADMIN, ASSESSMENT_TEACHER, QUESTION_DEVELOPER, SYSTEM_ADMIN
-- student_grade_level: GRADE_A, GRADE_B (2단계)
-- =====================================================
create table if not exists public.users (
  user_id bigint generated by default as identity primary key,
  email text not null unique,
  name text not null,
  user_type text not null,
  birth_date date,
  phone text,
  school_name text,
  school_id bigint references public.schools(school_id) on delete set null,
  grade integer,
  student_grade_level text,
  profile_image_url text,
  is_active boolean default true,
  password_hash text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- 학교 관리자 연결 (schools 테이블에 admin_user_id 추가)
alter table public.schools
  add column if not exists admin_user_id bigint references public.users(user_id) on delete set null;

-- =====================================================
-- 반 편성 테이블
-- =====================================================
create table if not exists public.classes (
  class_id bigint generated by default as identity primary key,
  school_id bigint not null references public.schools(school_id) on delete cascade,
  class_name text not null,
  grade_year integer,
  class_number integer,
  academic_year integer not null,
  teacher_id bigint references public.users(user_id) on delete set null,
  max_students integer default 40,
  is_active boolean default true,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- users 테이블에 class_id 연결
alter table public.users
  add column if not exists class_id bigint references public.classes(class_id) on delete set null;

-- =====================================================
-- 반-학생 연결 테이블
-- =====================================================
create table if not exists public.class_students (
  class_student_id bigint generated by default as identity primary key,
  class_id bigint not null references public.classes(class_id) on delete cascade,
  student_id bigint not null references public.users(user_id) on delete cascade,
  student_number integer,
  enrolled_at timestamptz default now(),
  is_active boolean default true,
  unique(class_id, student_id)
);

-- =====================================================
-- 학생-학부모 연결 테이블
-- =====================================================
create table if not exists public.student_parents (
  student_parent_id bigint generated by default as identity primary key,
  student_id bigint not null references public.users(user_id) on delete cascade,
  parent_id bigint not null references public.users(user_id) on delete cascade,
  relationship text,
  is_primary boolean default false,
  created_at timestamptz default now(),
  unique(student_id, parent_id)
);

-- =====================================================
-- 동의서 템플릿 테이블
-- =====================================================
create table if not exists public.consent_templates (
  template_id bigint generated by default as identity primary key,
  consent_type text not null,
  version text not null,
  title text not null,
  content text not null,
  is_required boolean default true,
  is_active boolean default true,
  created_at timestamptz default now(),
  updated_at timestamptz default now(),
  unique(consent_type, version)
);

-- =====================================================
-- 동의서 관리 테이블
-- consent_type: STUDENT_PRIVACY, PARENT_CONSENT, ASSESSMENT_CONSENT, DATA_USAGE_CONSENT
-- =====================================================
create table if not exists public.consents (
  consent_id bigint generated by default as identity primary key,
  user_id bigint not null references public.users(user_id) on delete cascade,
  consent_type text not null,
  consent_version text not null,
  is_agreed boolean not null,
  agreed_at timestamptz,
  ip_address text,
  user_agent text,
  target_student_id bigint references public.users(user_id) on delete set null,
  expires_at timestamptz,
  created_at timestamptz default now()
);

-- =====================================================
-- 상담 신청 테이블
-- consultation_type: ASSESSMENT_RESULT, LEARNING_PLAN, GENERAL
-- status: REQUESTED, SCHEDULED, COMPLETED, CANCELLED
-- =====================================================
create table if not exists public.consultations (
  consultation_id bigint generated by default as identity primary key,
  requester_id bigint not null references public.users(user_id) on delete cascade,
  student_id bigint not null references public.users(user_id) on delete cascade,
  teacher_id bigint references public.users(user_id) on delete set null,
  consultation_type text not null,
  status text default 'REQUESTED',
  requested_date date,
  requested_time_slot text,
  scheduled_at timestamptz,
  completed_at timestamptz,
  request_message text,
  consultation_notes text,
  related_assessment_id bigint references public.assessments(assessment_id) on delete set null,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- =====================================================
-- 권한 정의 테이블
-- =====================================================
create table if not exists public.permissions (
  permission_id bigint generated by default as identity primary key,
  permission_code text not null unique,
  permission_name text not null,
  description text,
  resource text not null,
  action text not null,
  created_at timestamptz default now()
);

-- =====================================================
-- 역할별 권한 매핑 테이블
-- =====================================================
create table if not exists public.role_permissions (
  role_permission_id bigint generated by default as identity primary key,
  user_type text not null,
  permission_id bigint not null references public.permissions(permission_id) on delete cascade,
  created_at timestamptz default now(),
  unique(user_type, permission_id)
);

-- =====================================================
-- 사용자별 추가 권한 테이블
-- =====================================================
create table if not exists public.user_permissions (
  user_permission_id bigint generated by default as identity primary key,
  user_id bigint not null references public.users(user_id) on delete cascade,
  permission_id bigint not null references public.permissions(permission_id) on delete cascade,
  granted_by bigint references public.users(user_id) on delete set null,
  granted_at timestamptz default now(),
  expires_at timestamptz,
  unique(user_id, permission_id)
);

-- =====================================================
-- 학생 등급 이력 테이블
-- =====================================================
create table if not exists public.student_grade_history (
  history_id bigint generated by default as identity primary key,
  student_id bigint not null references public.users(user_id) on delete cascade,
  previous_grade text,
  new_grade text not null,
  reason text,
  assessment_id bigint references public.assessments(assessment_id) on delete set null,
  changed_by bigint references public.users(user_id) on delete set null,
  changed_at timestamptz default now()
);

create table if not exists public.books (
  book_id bigint generated by default as identity primary key,
  title text not null,
  author text not null,
  publisher text,
  published_year integer,
  isbn text,
  category text,
  description text,
  cover_image_url text,
  difficulty_level text,
  created_at timestamptz default now()
);

create table if not exists public.topics (
  topic_id bigint generated by default as identity primary key,
  book_id bigint references public.books(book_id) on delete set null,
  topic_text text not null,
  topic_type text not null,
  difficulty_level integer,
  keywords text[],
  evaluation_criteria jsonb,
  created_at timestamptz default now()
);

create table if not exists public.assessments (
  assessment_id bigint generated by default as identity primary key,
  student_id bigint references public.users(user_id) on delete cascade,
  topic_id bigint references public.topics(topic_id) on delete set null,
  assessment_type text not null,
  status text not null,
  started_at timestamptz,
  submitted_at timestamptz,
  time_limit_minutes integer,
  word_count_min integer,
  word_count_max integer,
  created_at timestamptz default now()
);

create table if not exists public.answers (
  answer_id bigint generated by default as identity primary key,
  assessment_id bigint references public.assessments(assessment_id) on delete cascade,
  content text,
  word_count integer,
  char_count integer,
  paragraph_count integer,
  auto_saved_at timestamptz,
  submitted_at timestamptz,
  version integer default 1,
  created_at timestamptz default now()
);

create table if not exists public.evaluations (
  evaluation_id bigint generated by default as identity primary key,
  answer_id bigint references public.answers(answer_id) on delete cascade,
  assessment_id bigint references public.assessments(assessment_id) on delete cascade,
  student_id bigint references public.users(user_id) on delete set null,
  evaluator_type text,
  book_analysis_score integer,
  creative_thinking_score integer,
  problem_solving_score integer,
  language_expression_score integer,
  expression_score integer,
  total_score integer,
  grade text,
  percentile integer,
  spelling_errors integer,
  spacing_errors integer,
  grammar_errors integer,
  vocabulary_level numeric,
  overall_comment text,
  comprehensive_feedback text,
  detailed_feedback text,
  strengths text[],
  weaknesses text[],
  improvements text[],
  student_feedback jsonb,
  rubric jsonb,
  line_edits jsonb,
  teacher_note text,
  evaluated_at timestamptz,
  created_at timestamptz default now()
);

alter table public.evaluations
  add column if not exists student_feedback jsonb,
  add column if not exists rubric jsonb,
  add column if not exists line_edits jsonb,
  add column if not exists teacher_note text;

-- Open policies for development/testing (tighten before production)
alter table public.users enable row level security;
alter table public.books enable row level security;
alter table public.topics enable row level security;
alter table public.assessments enable row level security;
alter table public.answers enable row level security;
alter table public.evaluations enable row level security;

-- Drop existing policies if they exist
drop policy if exists "dev_read_users" on public.users;
drop policy if exists "dev_write_users" on public.users;
drop policy if exists "dev_update_users" on public.users;
drop policy if exists "dev_delete_users" on public.users;

drop policy if exists "dev_read_books" on public.books;
drop policy if exists "dev_write_books" on public.books;
drop policy if exists "dev_update_books" on public.books;
drop policy if exists "dev_delete_books" on public.books;

drop policy if exists "dev_read_topics" on public.topics;
drop policy if exists "dev_write_topics" on public.topics;
drop policy if exists "dev_update_topics" on public.topics;
drop policy if exists "dev_delete_topics" on public.topics;

drop policy if exists "dev_read_assessments" on public.assessments;
drop policy if exists "dev_write_assessments" on public.assessments;
drop policy if exists "dev_update_assessments" on public.assessments;
drop policy if exists "dev_delete_assessments" on public.assessments;

drop policy if exists "dev_read_answers" on public.answers;
drop policy if exists "dev_write_answers" on public.answers;
drop policy if exists "dev_update_answers" on public.answers;
drop policy if exists "dev_delete_answers" on public.answers;

drop policy if exists "dev_read_evaluations" on public.evaluations;
drop policy if exists "dev_write_evaluations" on public.evaluations;
drop policy if exists "dev_update_evaluations" on public.evaluations;
drop policy if exists "dev_delete_evaluations" on public.evaluations;

-- Create policies
create policy "dev_read_users" on public.users for select using (true);
create policy "dev_write_users" on public.users for insert with check (true);
create policy "dev_update_users" on public.users for update using (true);
create policy "dev_delete_users" on public.users for delete using (true);

create policy "dev_read_books" on public.books for select using (true);
create policy "dev_write_books" on public.books for insert with check (true);
create policy "dev_update_books" on public.books for update using (true);
create policy "dev_delete_books" on public.books for delete using (true);

create policy "dev_read_topics" on public.topics for select using (true);
create policy "dev_write_topics" on public.topics for insert with check (true);
create policy "dev_update_topics" on public.topics for update using (true);
create policy "dev_delete_topics" on public.topics for delete using (true);

create policy "dev_read_assessments" on public.assessments for select using (true);
create policy "dev_write_assessments" on public.assessments for insert with check (true);
create policy "dev_update_assessments" on public.assessments for update using (true);
create policy "dev_delete_assessments" on public.assessments for delete using (true);

create policy "dev_read_answers" on public.answers for select using (true);
create policy "dev_write_answers" on public.answers for insert with check (true);
create policy "dev_update_answers" on public.answers for update using (true);
create policy "dev_delete_answers" on public.answers for delete using (true);

create policy "dev_read_evaluations" on public.evaluations for select using (true);
create policy "dev_write_evaluations" on public.evaluations for insert with check (true);
create policy "dev_update_evaluations" on public.evaluations for update using (true);
create policy "dev_delete_evaluations" on public.evaluations for delete using (true);

create table if not exists public.feedbacks (
  feedback_id bigint generated by default as identity primary key,
  evaluation_id bigint references public.evaluations(evaluation_id) on delete cascade,
  teacher_id bigint references public.users(user_id) on delete set null,
  student_id bigint references public.users(user_id) on delete set null,
  assessment_id bigint references public.assessments(assessment_id) on delete set null,
  answer_id bigint references public.answers(answer_id) on delete set null,
  summary_intro text,
  summary_body text,
  summary_conclusion text,
  topic_understanding text,
  example_analysis text,
  logical_flow text,
  expression text,
  feedback_status text default 'PENDING',
  rubric jsonb,
  line_edits jsonb,
  strengths text[],
  weaknesses text[],
  improvements text[],
  teacher_note text,
  submitted_at timestamptz,
  created_at timestamptz default now()
);

alter table public.feedbacks
  add column if not exists teacher_id bigint references public.users(user_id) on delete set null,
  add column if not exists topic_understanding text,
  add column if not exists example_analysis text,
  add column if not exists logical_flow text,
  add column if not exists expression text,
  add column if not exists feedback_status text,
  add column if not exists submitted_at timestamptz;

alter table public.feedbacks enable row level security;

drop policy if exists "dev_read_feedbacks" on public.feedbacks;
drop policy if exists "dev_write_feedbacks" on public.feedbacks;
drop policy if exists "dev_update_feedbacks" on public.feedbacks;
drop policy if exists "dev_delete_feedbacks" on public.feedbacks;

create policy "dev_read_feedbacks" on public.feedbacks for select using (true);
create policy "dev_write_feedbacks" on public.feedbacks for insert with check (true);
create policy "dev_update_feedbacks" on public.feedbacks for update using (true);
create policy "dev_delete_feedbacks" on public.feedbacks for delete using (true);

create table if not exists public.progress_history (
  history_id bigint generated by default as identity primary key,
  student_id bigint references public.users(user_id) on delete cascade,
  assessment_id bigint references public.assessments(assessment_id) on delete set null,
  total_score integer,
  book_analysis_score integer,
  creative_thinking_score integer,
  problem_solving_score integer,
  language_expression_score integer,
  recorded_at timestamptz default now()
);

alter table public.progress_history enable row level security;

drop policy if exists "dev_read_progress_history" on public.progress_history;
drop policy if exists "dev_write_progress_history" on public.progress_history;
drop policy if exists "dev_update_progress_history" on public.progress_history;
drop policy if exists "dev_delete_progress_history" on public.progress_history;

create policy "dev_read_progress_history" on public.progress_history for select using (true);
create policy "dev_write_progress_history" on public.progress_history for insert with check (true);
create policy "dev_update_progress_history" on public.progress_history for update using (true);
create policy "dev_delete_progress_history" on public.progress_history for delete using (true);

-- =====================================================
-- 새로 추가된 테이블들의 RLS 정책
-- =====================================================

-- schools 테이블 RLS
alter table public.schools enable row level security;
drop policy if exists "dev_read_schools" on public.schools;
drop policy if exists "dev_write_schools" on public.schools;
drop policy if exists "dev_update_schools" on public.schools;
drop policy if exists "dev_delete_schools" on public.schools;
create policy "dev_read_schools" on public.schools for select using (true);
create policy "dev_write_schools" on public.schools for insert with check (true);
create policy "dev_update_schools" on public.schools for update using (true);
create policy "dev_delete_schools" on public.schools for delete using (true);

-- classes 테이블 RLS
alter table public.classes enable row level security;
drop policy if exists "dev_read_classes" on public.classes;
drop policy if exists "dev_write_classes" on public.classes;
drop policy if exists "dev_update_classes" on public.classes;
drop policy if exists "dev_delete_classes" on public.classes;
create policy "dev_read_classes" on public.classes for select using (true);
create policy "dev_write_classes" on public.classes for insert with check (true);
create policy "dev_update_classes" on public.classes for update using (true);
create policy "dev_delete_classes" on public.classes for delete using (true);

-- class_students 테이블 RLS
alter table public.class_students enable row level security;
drop policy if exists "dev_read_class_students" on public.class_students;
drop policy if exists "dev_write_class_students" on public.class_students;
drop policy if exists "dev_update_class_students" on public.class_students;
drop policy if exists "dev_delete_class_students" on public.class_students;
create policy "dev_read_class_students" on public.class_students for select using (true);
create policy "dev_write_class_students" on public.class_students for insert with check (true);
create policy "dev_update_class_students" on public.class_students for update using (true);
create policy "dev_delete_class_students" on public.class_students for delete using (true);

-- student_parents 테이블 RLS
alter table public.student_parents enable row level security;
drop policy if exists "dev_read_student_parents" on public.student_parents;
drop policy if exists "dev_write_student_parents" on public.student_parents;
drop policy if exists "dev_update_student_parents" on public.student_parents;
drop policy if exists "dev_delete_student_parents" on public.student_parents;
create policy "dev_read_student_parents" on public.student_parents for select using (true);
create policy "dev_write_student_parents" on public.student_parents for insert with check (true);
create policy "dev_update_student_parents" on public.student_parents for update using (true);
create policy "dev_delete_student_parents" on public.student_parents for delete using (true);

-- consent_templates 테이블 RLS
alter table public.consent_templates enable row level security;
drop policy if exists "dev_read_consent_templates" on public.consent_templates;
drop policy if exists "dev_write_consent_templates" on public.consent_templates;
drop policy if exists "dev_update_consent_templates" on public.consent_templates;
drop policy if exists "dev_delete_consent_templates" on public.consent_templates;
create policy "dev_read_consent_templates" on public.consent_templates for select using (true);
create policy "dev_write_consent_templates" on public.consent_templates for insert with check (true);
create policy "dev_update_consent_templates" on public.consent_templates for update using (true);
create policy "dev_delete_consent_templates" on public.consent_templates for delete using (true);

-- consents 테이블 RLS
alter table public.consents enable row level security;
drop policy if exists "dev_read_consents" on public.consents;
drop policy if exists "dev_write_consents" on public.consents;
drop policy if exists "dev_update_consents" on public.consents;
drop policy if exists "dev_delete_consents" on public.consents;
create policy "dev_read_consents" on public.consents for select using (true);
create policy "dev_write_consents" on public.consents for insert with check (true);
create policy "dev_update_consents" on public.consents for update using (true);
create policy "dev_delete_consents" on public.consents for delete using (true);

-- consultations 테이블 RLS
alter table public.consultations enable row level security;
drop policy if exists "dev_read_consultations" on public.consultations;
drop policy if exists "dev_write_consultations" on public.consultations;
drop policy if exists "dev_update_consultations" on public.consultations;
drop policy if exists "dev_delete_consultations" on public.consultations;
create policy "dev_read_consultations" on public.consultations for select using (true);
create policy "dev_write_consultations" on public.consultations for insert with check (true);
create policy "dev_update_consultations" on public.consultations for update using (true);
create policy "dev_delete_consultations" on public.consultations for delete using (true);

-- permissions 테이블 RLS
alter table public.permissions enable row level security;
drop policy if exists "dev_read_permissions" on public.permissions;
drop policy if exists "dev_write_permissions" on public.permissions;
drop policy if exists "dev_update_permissions" on public.permissions;
drop policy if exists "dev_delete_permissions" on public.permissions;
create policy "dev_read_permissions" on public.permissions for select using (true);
create policy "dev_write_permissions" on public.permissions for insert with check (true);
create policy "dev_update_permissions" on public.permissions for update using (true);
create policy "dev_delete_permissions" on public.permissions for delete using (true);

-- role_permissions 테이블 RLS
alter table public.role_permissions enable row level security;
drop policy if exists "dev_read_role_permissions" on public.role_permissions;
drop policy if exists "dev_write_role_permissions" on public.role_permissions;
drop policy if exists "dev_update_role_permissions" on public.role_permissions;
drop policy if exists "dev_delete_role_permissions" on public.role_permissions;
create policy "dev_read_role_permissions" on public.role_permissions for select using (true);
create policy "dev_write_role_permissions" on public.role_permissions for insert with check (true);
create policy "dev_update_role_permissions" on public.role_permissions for update using (true);
create policy "dev_delete_role_permissions" on public.role_permissions for delete using (true);

-- user_permissions 테이블 RLS
alter table public.user_permissions enable row level security;
drop policy if exists "dev_read_user_permissions" on public.user_permissions;
drop policy if exists "dev_write_user_permissions" on public.user_permissions;
drop policy if exists "dev_update_user_permissions" on public.user_permissions;
drop policy if exists "dev_delete_user_permissions" on public.user_permissions;
create policy "dev_read_user_permissions" on public.user_permissions for select using (true);
create policy "dev_write_user_permissions" on public.user_permissions for insert with check (true);
create policy "dev_update_user_permissions" on public.user_permissions for update using (true);
create policy "dev_delete_user_permissions" on public.user_permissions for delete using (true);

-- student_grade_history 테이블 RLS
alter table public.student_grade_history enable row level security;
drop policy if exists "dev_read_student_grade_history" on public.student_grade_history;
drop policy if exists "dev_write_student_grade_history" on public.student_grade_history;
drop policy if exists "dev_update_student_grade_history" on public.student_grade_history;
drop policy if exists "dev_delete_student_grade_history" on public.student_grade_history;
create policy "dev_read_student_grade_history" on public.student_grade_history for select using (true);
create policy "dev_write_student_grade_history" on public.student_grade_history for insert with check (true);
create policy "dev_update_student_grade_history" on public.student_grade_history for update using (true);
create policy "dev_delete_student_grade_history" on public.student_grade_history for delete using (true);
